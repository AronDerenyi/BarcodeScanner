<!DOCTYPE html>
<html lang="en">

	<head>

		<meta charset="utf-8">

		<title>Made by Aron</title>

	</head>

	<body style="background: black;">

		<video id="video" autoplay style="
			width: 100vw;
			height: 100vh;
			position: fixed;
			top: 0;
			left: 0;
			background: black;"></video>

		<!--<div style="-->
			<!--width: 100vw;-->
			<!--height: 0;-->
			<!--position: fixed;-->
			<!--top: 50vh;-->
			<!--left: 0;-->
			<!--border: 1px solid rgba(255, 0, 0, 1);-->
			<!--mix-blend-mode: lighten"></div>-->

		<canvas id="canvas" style="
			position: fixed;
			width: 100vw;
			top: 50vh;
			left: 0;
			transform: scaleY(5)"></canvas>

		<p style="
			position: fixed;
			top: 0;
			left: 0;
			color: white;
			font-size: 12px;">12</p>

	</body>

</html>

<script>
	var video = document.getElementById("video");
	var canvas = document.getElementById("canvas");
	var context = canvas.getContext("2d");

	if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
		navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
			const track = stream.getVideoTracks()[0];
			new ImageCapture(track).getPhotoCapabilities().then(function() {
				track.applyConstraints({
					advanced: [
						{torch: true},
						{focusMode: "continuous"}
					]
				});
			});

			video.src = window.URL.createObjectURL(stream);
			video.play();
			loop();
		});
	}

	function loop() {
		if (video.videoWidth > 0 && video.videoHeight > 0) process();
		setTimeout(loop, 100);
	}

	function process() {
		var width = video.videoWidth;
		var height = video.videoHeight;

		canvas.width = width;
		canvas.height = 1;

		// Retrieving the middle row of pixels from the video
		context.drawImage(video, 0, -height / 2, width, height);
		var imageData = context.getImageData(0, 0, width, 1).data;
		var luminance = [];
		var difference = [];
		var groups = [];

		// Creating luminance
		for (var i = 0; i < width; i++) {
			var r = imageData[i * 4] / 255.0;
			var g = imageData[i * 4 + 1] / 255.0;
			var b = imageData[i * 4 + 2] / 255.0;
			luminance[i] = r * 0.299 + g * 0.587 + b * 0.114;
		}

		// Creating luminance difference
		for (var i = 0; i < width; i++) {
			var prevLum = luminance[(i > 0) ? (i - 1) : 0];
			var nextLum = luminance[(i < width - 1) ? (i + 1) : (width - 1)];
			difference[i] = nextLum - prevLum;
		}

		// Grouping luminance difference
		var threshold = 0.2;
		var groupStart = -1;
		var groupDirection = 0;
		for (var i = 0; i < width; i++) {
			var direction = difference[i];

			if (direction < -threshold) {
				direction = -1;
			} else if (direction > threshold) {
				direction = 1;
			} else {
				direction = 0;
			}

			if (groupStart === -1 || direction !== groupDirection) {
				if (groupStart >= 0 && groupDirection !== 0) {
					var groupLength = i - groupStart;
					var centerOffset = groupLength / 6;
					var groupCenter = groupStart + groupLength / 2 + centerOffset * groupDirection;
					groups.push({
						start: groupStart,
						length: groupLength,
						center: groupCenter,
						direction: groupDirection
					});
				}

				groupStart = i;
				groupDirection = direction;
			}
		}

		// Try to interpret
		var result = null;
		for (var i = 0; i < groups.length && result === null; i++) {
			result = parseEAN_13(groups.slice(i));
		}
		if (result) alert(result.toString());

		// Drawing for debugging
		groups.forEach(function(group) {
			var r = group.direction * 255;
			var g = 0;
			var b = -group.direction * 255;

			context.fillStyle = "rgb(" +
				Math.min(Math.max(Math.floor(r), 0), 255) + ", " +
				Math.min(Math.max(Math.floor(g), 0), 255) + ", " +
				Math.min(Math.max(Math.floor(b), 0), 255) + ")";

			context.fillRect(group.center, 0, 1, 1);
		});
	}

	function parseEAN_13(groups) {
		if (groups.length < 60) return null;
		groups = groups.slice(0, 60);

		for (var i = 0; i < 60; i++) {
			if (i % 2 === 0) {
				if (groups[i].direction !== -1) return null;
			} else {
				if (groups[i].direction !== 1) return null;
			}
		}

//		var leftGuard = groups.slice(0, 4);
//		var centerGuard = groups.slice(27, 33);
//		var rightGuard = groups.slice(56, 60);
//
//		var bitSize = 0;
//		bitSize += leftGuard[1].center - leftGuard[0].center;
//		bitSize += leftGuard[2].center - leftGuard[1].center;
//		bitSize += leftGuard[3].center - leftGuard[2].center;
//		bitSize += centerGuard[1].center - centerGuard[0].center;
//		bitSize += centerGuard[2].center - centerGuard[1].center;
//		bitSize += centerGuard[3].center - centerGuard[2].center;
//		bitSize += centerGuard[4].center - centerGuard[3].center;
//		bitSize += centerGuard[5].center - centerGuard[4].center;
//		bitSize += rightGuard[1].center - rightGuard[0].center;
//		bitSize += rightGuard[2].center - rightGuard[1].center;
//		bitSize += rightGuard[3].center - rightGuard[2].center;
//		bitSize /= 11;
//
//		var data = [];
//		for (var i = 0; i < 59; i++) {
//			var barSize = groups[i + 1].center - groups[i].center;
//			var bits = Math.round(barSize / bitSize);
//			if (bits < 1) {
//				console.log("Bar too small: " + bits + " bits < 1 bits");
//				return null;
//			}
//			if (bits > 4) {
//				console.log("Bar too big: " + bits + " bits > 4 bits");
//				return null;
//			}
//			for (var j = 0; j < bits; j++) {
//				data.push(((i % 2 === 0) ? 0 : 1));
//			}
//		}
//		if (data.length < 95) {
//			console.log("Bit count not correct: " + data.length + " bits != 95 bits");
//			return null;
//		}

		var start = groups[0].center;
		var end = groups[59].center;
		var data = [];

		var prevGroupIndex = 0;
		for (var i = 0; i < 95; i++) {
			while ((groups[prevGroupIndex + 1].center - start) / (end - start) * 95 < i) {
				prevGroupIndex++;
			}
			if (groups[prevGroupIndex].direction < 0) data[i] = 1;
			if (groups[prevGroupIndex].direction > 0) data[i] = 0;
		}

		console.log(data.join(""));

		var leftHandOdd = {"0001101": 0, "0011001": 1, "0010011": 2, "0111101": 3, "0100011": 4,
			"0110001": 5, "0101111": 6, "0111011": 7, "0110111": 8, "0001011": 9};

		var leftHandEven = {"0100111": 0, "0110011": 1, "0011011": 2, "0100001": 3, "0011101": 4,
			"0111001": 5, "0000101": 6, "0010001": 7, "0001001": 8, "0010111": 9};

		var rightHand = {"1110010": 0, "1100110": 1, "1101100": 2, "1000010": 3, "1011100": 4,
			"1001110": 5, "1010000": 6, "1000100": 7, "1001000": 8, "1110100": 9};

		var numbers = [];
		data.splice(0, 3);
		for (var i = 0; i < 6; i++) {
			var str = data.splice(0, 7).join("");
			var number = (i % 2 === 0 ? leftHandOdd : leftHandEven)[str];

			if (!number) {
				console.log("Couldn't parse number on left " + (i % 2 === 0 ? "odd" : "even") + ": " + str);
				return null;
			} else {
				numbers.push(number);
			}
		}
		data.splice(0, 5);
		for (var i = 0; i < 6; i++) {
			var str = data.splice(0, 7).join("");
			var number = rightHand[str];

			if (!number) {
				console.log("Couldn't parse number on right: " + str);
				return null;
			} else {
				numbers.push(number);
			}
		}
		data.splice(0, 3);
		return numbers;
	}
</script>
